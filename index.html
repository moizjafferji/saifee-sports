<!DOCTYPE html>
<html>
<head>
  
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Saifee Sports</title>
  <style>
    :root{
      /* Colors */
      --bg:#0b1220; --surface:#0f172a; --card:#0e1626; --muted:#9fb3c8; --text:#e6eef8;
      --accent:#3b82f6; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --border:#223;

      /* Fluid type scale */
      --fs-xxxs: clamp(20px, 8vw, 24px);
      --fs-xxs: clamp(20px, 10vw, 30px);
      --fs-xs:  clamp(25px, 13vw, 35px);
      --fs-sm:  clamp(30px, 16vw, 40px);
      --fs-md:  clamp(35px, 19vw, 45px);
      --fs-lg:  clamp(40px, 22vw, 50px);
      --fs-xl:  clamp(45px, 25vw, 55px);

      /* Layout */
      --sidebar-w: clamp(200px, 30vw, 300px);
      --radius: 16px;
      --pad: 14px;
      --gap: 12px;
      --elev: 0 10px 28px rgba(0,0,0,.35);

      --topbar-h: clamp(56px, 9vh, 110px);
    }
    *{ box-sizing:border-box }
    html, body{ height:100% }
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:var(--text);
      font-size:var(--fs-md); line-height:1.35;
    }

    .app{ display:flex; min-height:100dvh; width:100%; position:relative; }
    .sidebar{
      width:var(--sidebar-w);
      background:var(--surface);
      border-right:1px solid var(--border);
      padding: calc(var(--pad) + 6px) var(--pad);
      position:sticky; top:0; align-self:flex-start; height:100dvh; overflow:auto;
      will-change: transform;
      transition: transform .25s ease;
    }
    .content{ flex:1; min-width:0; padding: var(--pad); }
    .container{ max-width:1100px; margin:0 auto; padding: var(--pad); }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--elev);
      padding: calc(var(--pad) + 6px);
    }

    .topbar{
      min-height: var(--topbar-h);
      display:flex;
      position:sticky; top:0; z-index:200;
      background:linear-gradient(180deg, rgba(12,16,29,.95), rgba(12,16,29,.70));
      backdrop-filter: blur(6px);
      padding: 10px var(--pad);
      border-bottom:1px solid var(--border);
    }

    .hamburger{
      min-width:88px;
      min-height:44px;
      line-height:1;
      touch-action:manipulation;
      -webkit-tap-highlight-color: transparent;
      background:transparent; color:var(--text);
      border:1px solid var(--border); border-radius:10px;
      padding:8px 12px; font-weight:700; cursor:pointer;
    }
    .brand{ display:flex; align-items:center; gap:10px; font-size:var(--fs-lg); font-weight:800; letter-spacing:.3px }
    .brand .logo{ width:28px; height:28px; object-fit:contain; border-radius:8px; border:1px solid var(--border); background:#0d1423 }
    #sidebar .logo{ width:126px; height:126px; }

    @media (max-width: 1433px){
      .sidebar{
        position: fixed;
        left: 0;
        top: var(--topbar-h);
        height: calc(100dvh - var(--topbar-h));
        z-index: 180;
        transform: translateX(-100%);
      }
      .sidebar.open{ transform: translateX(0); }
      .content{ padding-top: 0; }

      .backdrop{
        position: fixed;
        left: 0; right: 0;
        top: var(--topbar-h);
        bottom: 0;
        background: rgba(0,0,0,.45);
        display: none;
        z-index: 160;
      }
      .backdrop.show{ display: block; }
    }

    @media (min-width: 601px){
      .sidebar.collapsed{
        position:fixed; left:0; top:0; height:100dvh; z-index:180;
        transform: translateX(-100%);
      }
    }

    .nav-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:16px; }
    .brand-left{ display:flex; align-items:center; gap:10px; }
    .logo{ width:42px; height:42px; object-fit:contain; border-radius:10px; border:1px solid var(--border); background:#0d1423; }
    .nav{ display:flex; flex-direction:column; gap:6px; }
    .nav a, .nav button.nav-item{
      display:flex; align-items:center; gap:10px;
      width:100%; padding:10px 12px;
      border-radius: 12px; border:1px solid transparent;
      background:transparent; color:#d7e5fb; text-decoration:none; cursor:pointer;
      font-size:var(--fs-sm);
    }
    .nav a.active, .nav button.nav-item.active{ background:#1d283a; border-color:#2a364c; color:#fff; }
    .nav-sep{ margin:8px 0; height:1px; background:var(--border) }
    .nav .group{ display:flex; flex-direction:column; gap:6px; }
    .submenu{ margin-left:8px; display:none; }
    .submenu.open{ display:flex; flex-direction:column; gap:6px; }
    .subitem{ padding-left:10px; font-size:var(--fs-xs) }

    .stack{ display:flex; flex-direction:column; gap: var(--gap); }
    .row{ display:flex; gap: var(--gap); flex-wrap: wrap; }
    .col{ flex:1 1 320px; min-width:280px; }
    .label{ font-size:var(--fs-xs); color:#BF0A30; }
    .tiny{ font-size:var(--fs-xxs); color:var(--muted); }
    .muted{ color:var(--muted) }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding: 11px 14px; border-radius:12px; border:1px solid #224;
      background:var(--accent); color:#fff; font-weight:700; cursor:pointer;
      font-size:var(--fs-sm);
    }
    .btn.secondary{ background:#1f2937; color:#dbeafe }
    .btn.danger{ background:#dc2626 }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    .input, select, input[type="date"], input[type="datetime-local"], input[type="number"], input[type="file"]{
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid #293247;
      background:#0e1626; color:var(--text); font-size:var(--fs-sm);
    }
    .table{ width:100%; border-collapse:collapse }
    .table th,.table td{
      padding:10px; border-bottom:1px solid var(--border); text-align:left; vertical-align: top;
    }
    .table--compact td { font-size: var(--fs-xxxs); }
    .table--compact th { font-size: var(--fs-xs); }

    .right{ text-align:right }

    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:var(--fs-xxs); border:1px solid transparent }
    .badge.ok{ background:rgba(22,163,74,.15); color:#8ee5a3; border-color:rgba(22,163,74,.35) }
    .badge.warn{ background:rgba(245,158,11,.15); color:#ffd089; border-color:rgba(245,158,11,.35) }

    .event-card{ padding:12px; border:1px solid var(--border); border-radius:12px; background:#0e1626 }
    .event-actions{ display:flex; gap:8px; flex-wrap:wrap }
    .countdown{ font-size:var(--fs-lg); font-weight:800 }
    .amt-credit{ color:#16a34a; font-weight:700 }
    .amt-debit{ color:#ef4444; font-weight:700 }

    .form-grid{ display:grid; grid-template-columns: 1fr; gap: var(--gap); }

    .hide{ display:none !important }
    .w-full{ width:100% }
    html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }

    #sidebar .hamburger, #btnNavCollapse{ display: none !important; }
  </style>
</head>
<body>
  <div class="app" id="appShell">
    <div class="backdrop" id="backdrop"></div>

    <aside class="sidebar" id="sidebar">
      <div class="nav-head">
        <div class="brand-left">
          <img id="logo" class="logo" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhGDd41RRLflpCpnJ6zrk8tZIWQ4rgNQS54N0CNUu4JSitj1pEsk4Ziu1emW06ph8I4Oqz80EiUGzh8fGk3aix-ARa7kqozocI7KpxG_ll1U5xkbl_ekUY7UTdw5W9KkRLlcPFlLYEptUtnHGcussYaRnVAUbBZYTCogDHMEAWr4kNGXQAvxYSxfzbQizCU/s16000/Saifee%20Sports%20Logo.png" alt="logo" onerror="this.style.display='none'"/>
          <div class="brand" style="font-size:var(--fs-xl)"></div>
        </div>
        <button class="hamburger" id="btnCollapse" title="Hide menu">☰</button>
      </div>
      <nav class="nav" id="nav"></nav>
    </aside>

    <main class="content">
      <div class="topbar">
        <button class="hamburger" id="btnMenu">☰ Menu</button>
        <div class="brand">
          <img id="logoTop" class="logo" src="" alt="logo" onerror="this.style.display='none'"/>
          <div>Saifee Sports</div>
        </div>
      </div>
      <div class="container"><div id="root"></div></div>
    </main>
  </div>

<script>
/* google.script.run polyfill for Cloudflare Pages (safe no-op on GAS)
   GET for a few cacheable reads; POST for everything else.
*/
(function () {
  if (window.google && google.script && google.script.run) return;

  const CACHEABLE_READS = new Set([
    'api_listEvents', 'api_upcomingEvents', 'api_eventDetails'
  ]);

  function runner(base, ctx = { ok: null, fail: null }) {
    return new Proxy(function () {}, {
      get(_t, prop) {
        if (prop === 'withSuccessHandler') return (fn) => runner(base, { ...ctx, ok: fn });
        if (prop === 'withFailureHandler') return (fn) => runner(base, { ...ctx, fail: fn });
        return function (...args) {
          const method = String(prop);
          (async () => {
            try {
              let res;
              if (CACHEABLE_READS.has(method)) {
                const url = base + '?method=' + encodeURIComponent(method) +
                            '&args=' + encodeURIComponent(JSON.stringify(args || []));
                res = await fetch(url, { method: 'GET' });
              } else {
                res = await fetch(base, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ method, args })
                });
              }
              if (!res.ok) throw new Error('HTTP ' + res.status);
              const data = await res.json();
              (ctx.ok || function(){})(data);
            } catch (e) {
              (ctx.fail || console.error)(e);
            }
          })();
          return runner(base, {});
        };
      }
    });
  }

  window.google = window.google || {};
  google.script = google.script || {};
  google.script.run = runner('/gas');
})();
</script>

<script>
  /* ===================== GLOBAL STATE ===================== */
  var state = {
    boot:null, user:null, page:'landing', sport:'Soccer', error:'', tmp:{},
    admin:{ adminSports:[], pastAddresses:[], adminEvents:[], autodraftLinks:[] },
    ui:{ menuOpen:false, sportsOpen:false }
  };
  var sportCountdownTimer = null;
  var homeTimers = { cd:null, uiRefresh:null };

  /* ===================== BOOT ===================== */
  google.script.run.withSuccessHandler(function(res){
    state.boot = res || {};
    if (state.boot && state.boot.logoUrl) {
      document.getElementById('logo').src = state.boot.logoUrl;
      document.getElementById('logoTop').src = state.boot.logoUrl;
    }
    restoreSession();
    render();
  }).api_bootstrap();

  /* ===================== UTILS ===================== */
  function $(sel, root){ return (root||document).querySelector(sel); }
  function el(html){ var t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
  function layout(n){ var root=document.getElementById('root'); root.innerHTML=''; root.appendChild(n); }
  function setPage(p){ state.page=p; state.error=''; closeMenu(); render(); }
  function setSport(sp){ state.sport=sp; setPage('sport'); }
  function money(n){ return '$'+(Number(n||0)).toFixed(2); }
  function ftIn(inches){ var v=Number(inches||0); var ft=Math.floor(v/12); var i=v%12; return v? (ft+'ft '+i+'in') : ''; }
  function fmtDate(s){ if(!s) return ''; var d=new Date(s); if(isNaN(d)) return ''; var mm=('0'+(d.getMonth()+1)).slice(-2); var dd=('0'+d.getDate()).slice(-2); var yy=d.getFullYear(); return mm+'/'+dd+'/'+yy; }
  function fmtDT(s){ try{ return new Date(s).toLocaleString(); }catch(_){return String(s||'');} }
  function parseDT(s){ var d=new Date(s); return isNaN(d)?null:d; }
  function now(){ return new Date(); }
  function guard(){ if(!state.user){ setPage('landing'); return false; } return true; }
  function showErr(sel, err){ var node=$(sel); if (node) node.textContent = (err && (err.message || err)) || 'Unexpected error'; }
  function humanCountdown(ms){
    var s = Math.max(0, Math.floor(ms/1000));
    var d = Math.floor(s/86400);
    var h = Math.floor((s%86400)/3600);
    var m = Math.floor((s%3600)/60);
    var ss = s%60;
    var parts=[]; if (d) parts.push(d+'d'); if (h || d) parts.push(h+'h'); if (m || d || h) parts.push(m+'m'); parts.push(ss+'s');
    return parts.join(' ');
  }
  function addrHtml(addr){
    return addr ? ('<a href="https://www.google.com/maps?q='+encodeURIComponent(addr)+'" target="_blank" rel="noopener">'+addr+'</a>') : '';
  }

  function saveSession(){ try { localStorage.setItem('saifee_user', JSON.stringify(state.user||null)); } catch(e){} }
  function restoreSession(){
    try {
      var saved = JSON.parse(localStorage.getItem('saifee_user') || 'null');
      if (saved && saved.its){
        state.user = saved;
        if (!state.page || state.page === 'landing') state.page = 'home';
        AdminAPI.bootstrap(saved.its, function(b){
          state.admin = Object.assign({adminSports:[],pastAddresses:[],adminEvents:[],autodraftLinks:[]}, b||{});
          render();
        }, console.warn);
      }
    } catch(e){}
  }
  function signOut(){
    try { localStorage.removeItem('saifee_user'); } catch(e){}
    state.user = null;
    state.admin = { adminSports:[], pastAddresses:[], adminEvents:[], autodraftLinks:[] };
    setPage('landing');
  }

  /* ===================== SERVER CALL WRAPPER ===================== */
  function callServer(primary, args, ok, err, fallback){
    try{
      google.script.run.withSuccessHandler(ok).withFailureHandler(function(e){
        if (fallback){
          google.script.run.withSuccessHandler(ok).withFailureHandler(err||console.error)[fallback].apply(google.script.run, args||[]);
        } else (err||console.error)(e);
      })[primary].apply(google.script.run, args||[]);
    }catch(e){
      if (fallback){
        try{
          google.script.run.withSuccessHandler(ok).withFailureHandler(err||console.error)[fallback].apply(google.script.run, args||[]);
        }catch(e2){ (err||console.error)(e2); }
      } else (err||console.error)(e);
    }
  }

  /* ===================== ADMIN API WRAPPERS ===================== */
  var AdminAPI = {
    bootstrap:function(its, cb, eb){ callServer('Events_adminBootstrap', [its], cb, eb, 'api_admin_bootstrap'); },
    eventsList:function(its, cb, eb){ callServer('Events_listForAdmin', [its], cb, eb, 'api_events_listForAdmin'); },
    eventSave:function(its, payload, cb, eb){ callServer('Events_save', [its, payload], cb, eb, 'api_events_save'); },
    eventDelete:function(its, id, cb, eb){ callServer('Events_delete', [its, id], cb, eb, 'api_events_delete'); },
    eventCopy:function(its, id, cb, eb){ callServer('Events_copy', [its, id], cb, eb, 'api_events_copy'); },
    receiptsList:function(its, cb, eb){ callServer('Receipts_listForAdmin', [its], cb, eb, 'api_receipts_listForAdmin'); },
    receiptSave:function(its, payload, cb, eb){ callServer('Receipts_save', [its, payload], cb, eb, 'api_receipts_save'); },
    receiptsFinalizeNow:function(its, eventId, cb, eb){ callServer('Receipts_finalizeNow', [its, eventId], cb, eb, 'api_receipts_finalizeNow'); },
    removeRegistration:function(its, eventId, personIts, cb, eb){
      callServer('Events_adminRemoveRegistration', [its, eventId, personIts], cb, eb, 'api_admin_removeRegistration');
    }
  };

  /* ===================== MENU TOGGLING ===================== */
  const MOBILE_MAX = 2000;
  function isMobileBP(){ return window.matchMedia(`(max-width: ${MOBILE_MAX}px)`).matches; }
  function toggleMenu(){
    const sb = document.getElementById('sidebar');
    const bd = document.getElementById('backdrop');
    if (isMobileBP()){
      const willOpen = !sb.classList.contains('open');
      sb.classList.toggle('open', willOpen);
      if (bd) bd.classList.toggle('show', willOpen);
    } else {
      sb.classList.toggle('collapsed');
    }
  }
  function closeMenu(){
    const sb = document.getElementById('sidebar');
    const bd = document.getElementById('backdrop');
    sb.classList.remove('open');
    sb.classList.remove('collapsed');
    if (bd) bd.classList.remove('show');
  }
  function wireMenuButtons(){
    const btn = document.getElementById('btnMenu');
    if (btn) btn.onclick = (e)=>{ e.stopPropagation(); toggleMenu(); };
    const bd = document.getElementById('backdrop');
    if (bd) bd.onclick = closeMenu;
  }
  window.addEventListener('resize', ()=>{
    const sb = document.getElementById('sidebar');
    const bd = document.getElementById('backdrop');
    if (isMobileBP()){
      sb.classList.remove('collapsed');
    } else {
      sb.classList.remove('open');
      if (bd) bd.classList.remove('show');
    }
  });
  wireMenuButtons();

  <script>
/* ===================== LEFT NAV (single source of truth) ===================== */
function buildNav(){
  var nav = $('#nav'); if (!nav) return;
  nav.innerHTML = '';

  function navItem(label, page, opts){
    var btn = el('<button class="nav-item">'+label+'</button>');
    if (state.page===page) btn.classList.add('active');
    btn.onclick = function(){ setPage(page); };
    if (opts && opts.test && !opts.test()) return null;
    nav.appendChild(btn);
    return btn;
  }
  function navLink(label, onClick, isActive){
    var btn = el('<button class="nav-item">'+label+'</button>');
    if (isActive) btn.classList.add('active');
    btn.onclick = onClick;
    nav.appendChild(btn);
    return btn;
  }

  // Primary tabs
  navItem('Home','home', { test: ()=> !!state.user });
  navItem('Profile','profile', { test: ()=> !!state.user });
  navItem('Balance','balance', { test: ()=> !!state.user });
  navItem('Calendar','calendar', { test: ()=> !!state.user });
  navItem('Guests','guests', { test: ()=> !!state.user });

  // Sports group
  if (state.user){
    var group = el('<div class="group"></div>');
    var trigger = el('<button class="nav-item">Sports ▾</button>');
    trigger.onclick = function(){
      state.ui.sportsOpen = !state.ui.sportsOpen;
      submenu.classList.toggle('open', state.ui.sportsOpen);
    };
    group.appendChild(trigger);

    var submenu = el('<div class="submenu '+(state.ui.sportsOpen?'open':'')+'"></div>');
    var sports = (state.boot && state.boot.sports) ? state.boot.sports : [];
    if (!sports.length) sports = ['Soccer','Basketball','Volleyball','Tennis'];
    sports.forEach(function(sp){
      var sbtn = el('<button class="nav-item subitem">'+sp+'</button>');
      if (state.page==='sport' && state.sport===sp) sbtn.classList.add('active');
      sbtn.onclick = function(){ setSport(sp); };
      submenu.appendChild(sbtn);
    });
    group.appendChild(submenu);
    nav.appendChild(group);
  }

  // Admin items + dynamic Captain/Autodraft links
  var hasAdminSports = (state.admin && state.admin.adminSports && state.admin.adminSports.length) ? true : false;
  if (state.user && hasAdminSports){
    nav.appendChild(el('<div class="nav-sep"></div>'));
    navItem('Events','admin_events');
    navItem('Receipts','admin_receipts');

    // Build "<Sport> Autodraft" links for any "<Sport> Captain" roles
    var captainSet = new Set(
      (state.admin.adminSports||[])
        .map(String)
        .map(s => s.toLowerCase().trim())
        .filter(s => s.endsWith(' captain'))
        .map(s => s.replace(/ captain$/,'').trim()) // => sport name only
    );

    var links = (state.admin && state.admin.autodraftLinks) ? state.admin.autodraftLinks : [];
    links.forEach(function(link){
      var sp = String(link.sport||'').trim();
      var id = String(link.sheetId||'').trim();
      if (!sp || !id) return;
      if (captainSet.has(sp.toLowerCase())){
        navLink(sp + ' Autodraft', function(){
          window.open('https://docs.google.com/spreadsheets/d/'+encodeURIComponent(id)+'/edit','_blank','noopener');
        }, false);
      }
    });
  }

  // Auth
  nav.appendChild(el('<div class="nav-sep"></div>'));
  if (state.user){
    navLink('Sign Out', function(){ if (confirm('Sign out?')) signOut(); }, false);
  } else {
    navLink('Sign In / Sign Up', function(){ setPage('landing'); }, state.page==='landing');
  }
}
</script>

  /* ===================== AUTH VIEWS ===================== */
  function pageLanding(){
    var hasLogo = (state.boot && state.boot.logoUrl);
    var node = el(
      '<div class="card stack">'+
        '<div style="display:flex;align-items:center;gap:12px">'+
          (hasLogo?('<img class="logo" src="'+state.boot.logoUrl+'" alt="logo"/>'):'')+
          '<div style="font-size:var(--fs-xl);font-weight:800">Welcome to Saifee Sports</div>'+
        '</div>'+
        '<div class="stack">'+
          '<div class="label">Sign In</div>'+
          '<form id="si_form" class="stack">'+
            '<input id="si_its" class="input" placeholder="ITS (8 digits)" maxlength="8" inputmode="numeric" pattern="[0-9]*">'+
            '<input id="si_whatsapp" class="input" placeholder="Whatsapp Number (10 digits)" type="password" maxlength="10" inputmode="numeric" pattern="[0-9]*">'+
            '<button class="btn" id="btnSignIn" type="submit">Sign In</button>'+
          '</form>'+
          '<div class="label">New here?</div>'+
          '<button class="btn secondary" id="btnSignUp">Create Profile</button>'+
          '<div class="tiny" id="si_err" style="color:var(--err)"></div>'+
        '</div>'+
      '</div>'
    );
    layout(node);
    $('#btnSignUp').onclick = function(){ setPage('create'); };

    function onlyDigits(id, max){
      var el2 = document.getElementById(id);
      if(!el2) return;
      el2.addEventListener('input', function(){ this.value = this.value.replace(/\D+/g,'').slice(0,max); });
    }
    onlyDigits('si_its',8); onlyDigits('si_whatsapp',10);

    $('#si_form').addEventListener('submit', function(e){ e.preventDefault(); actSignIn(); });
  }
  function actSignIn(){
    var its=$('#si_its').value.trim(); var whatsapp=$('#si_whatsapp').value.trim(); var err=$('#si_err'); err.textContent='';
    if(!/^\d{8}$/.test(its)) { err.textContent='Enter an 8-digit ITS'; return; }
    if(!/^\d{10}$/.test(whatsapp)) { err.textContent='Enter a 10-digit Whatsapp Number'; return; }
    google.script.run.withSuccessHandler(function(res){
      if(!res||!res.ok){ err.textContent=(res&&res.error)||'Invalid credentials'; return; }
      state.user=res.user; saveSession();

      AdminAPI.bootstrap(state.user.its, function(b){
        state.admin = Object.assign({adminSports:[],pastAddresses:[],adminEvents:[],autodraftLinks:[]}, b||{});
      }, console.warn);

      var hasLogo = (state.boot && state.boot.logoUrl);
      var anim = el('<div class="card stack" style="align-items:center;text-align:center">'
        +(hasLogo?('<img class="logo" src="'+state.boot.logoUrl+'"/>'):'')
        +'<div>Welcome, '+(state.user.first_name||'Athlete')+'!</div></div>');
      layout(anim);

      setTimeout(function(){
        setPage(res.requireValidation ? 'edit' : 'home');
      }, 900);
    }).api_signIn({its:its, whatsapp:whatsapp});
  }

  /* ===================== SHARED HELPERS ===================== */
  function withinCheckInWindow(evt){
    var start = parseDT(evt && evt.start_datetime);
    if (!start) return false;
    var end   = parseDT(evt && evt.end_datetime);
    var nowTs = now();
    var openAt  = new Date(start.getTime() - 30*60*1000);
    var closeAt = end ? new Date(end.getTime() - 30*60*1000) : new Date(start.getTime() + 30*60*1000);
    return nowTs >= openAt && nowTs <= closeAt;
  }
  function doCheckIn(eventId, itsOrGuest, btnEl){
    if(!navigator.geolocation){ alert('Location not available on this device/browser.'); return; }
    var originalText = btnEl ? btnEl.textContent : '';
    if (btnEl){ btnEl.disabled = true; btnEl.textContent = 'Checking…'; }
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = pos.coords.latitude, lng = pos.coords.longitude;
      google.script.run
        .withSuccessHandler(function(r){
          if(!r || !r.ok){
            alert((r && r.error) || 'Check-in failed');
            if (btnEl){ btnEl.disabled = false; btnEl.textContent = originalText; }
            return;
          }
          if (btnEl){
            btnEl.disabled = true;
            btnEl.textContent = 'Checked In';
            btnEl.classList.add('checked-in');
          } else {
            alert('Check-in successfully recorded!');
          }
        })
        .withFailureHandler(function(e){
          alert('Check-in failed: ' + (e && e.message || e));
          if (btnEl){ btnEl.disabled = false; btnEl.textContent = originalText; }
        })
        .api_checkInWithLocation(state.user.its, eventId, (itsOrGuest || state.user.its), lat, lng);
    }, function(err){
      alert('Could not get your location: ' + (err && err.message ? err.message : 'Unknown error'));
      if (btnEl){ btnEl.disabled = false; btnEl.textContent = originalText; }
    }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
  }
  function refreshCheckinButtonsVisibility(){
    document.querySelectorAll('.js-checkin-btn').forEach(function(btn){
      if (btn.classList.contains('checked-in')) return;
      var start = btn.getAttribute('data-start');
      var end   = btn.getAttribute('data-end');
      if (!start){ btn.style.display = 'none'; return; }
      var evt = { start_datetime: start, end_datetime: end };
      var can = withinCheckInWindow(evt);
      btn.style.display = can ? 'inline-flex' : 'none';
      btn.disabled = !can;
    });
  }
  function computeStatusBadge(st){
    var s = String(st||'none').toLowerCase();
    if (s==='active')   return '<span class="badge ok">Active</span>';
    if (s==='waitlist') return '<span class="badge warn">Waitlist</span>';
    if (s==='dropout')  return '<span class="badge warn">Dropped Out</span>';
    return '';
  }

  /* ===================== HOME ===================== */
  function pageHome(){ if(!guard())return;

    if (homeTimers.cd){ clearInterval(homeTimers.cd); homeTimers.cd = null; }
    if (homeTimers.uiRefresh){ clearInterval(homeTimers.uiRefresh); homeTimers.uiRefresh = null; }

    var node = el(
      '<div class="stack">'+
        '<div class="card stack">'+
          '<div class="label">Your Next Event</div>'+
          '<div id="home_cd" class="countdown muted">Looking for your next registration…</div>'+
          '<div id="home_cd_sub" class="tiny"></div>'+
          '<div><button class="btn js-checkin-btn" id="home_checkin" style="display:none"></button></div>'+
        '</div>'+
        '<div class="card stack">'+
          '<div class="label">Balance</div>'+
          '<div id="home_balance" style="font-size:var(--fs-xl);font-weight:800">—</div>'+
        '</div>'+
        '<div class="card stack">'+
          '<div class="label">Your Events</div>'+
          '<div id="home_self"></div>'+
        '</div>'+
        '<div class="card stack">'+
          '<div class="label">Guest Events</div>'+
          '<div id="home_guests"><div class="tiny muted">Loading…</div></div>'+
        '</div>'+
        '<div class="card stack">'+
          '<div class="label">Upcoming Events</div>'+
          '<div id="home_upcoming"></div>'+
        '</div>'+
      '</div>'
    );
    layout(node);

    google.script.run.withSuccessHandler(function(res){
      $('#home_balance').textContent = money(res.balance||0);
    }).api_balance(state.user.its);

    google.script.run.withSuccessHandler(function(h){
      var selfList   = (h && h.self)   || [];
      var guestList  = (h && h.guests) || [];
      var nextSelf   = (h && h.nextSelf) || null;

      var nowTs = now(); var today=new Date(nowTs);
      function isSameDay(d){ return d && d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth() && d.getDate()===today.getDate(); }
      function isFutureOngoingOrToday(e){
        var end   = parseDT(e && e.end_datetime);
        var start = parseDT(e && e.start_datetime);
        if (end) return (end > nowTs) || isSameDay(end) || isSameDay(start);
        return (start && start > nowTs) || isSameDay(start);
      }
      selfList  = selfList.filter(isFutureOngoingOrToday).sort(function(a,b){ return parseDT(a.start_datetime)-parseDT(b.start_datetime); });
      guestList = guestList.filter(isFutureOngoingOrToday).sort(function(a,b){ return parseDT(a.start_datetime)-parseDT(b.start_datetime); });

      // Your Events
      (function renderSelfRows(){
        var box = $('#home_self');
        if (!selfList.length){ box.innerHTML = '<div class="muted">No upcoming events</div>'; return; }
        box.innerHTML = selfList.map(function(e){
          var badge = computeStatusBadge(e.status);
          var title = (e.sport ? (e.sport+' - ') : '') + (e.name||'Event');
          var sub   = (e.start_datetime ? (fmtDT(e.start_datetime)) : '') + (e.address ? ('<br/>' + addrHtml(e.address)) : '');
          var eid   = (e.id || e.event_id || e.eventId || e.ID || e.Id || '');
          var actId = 'self_actions_'+eid;
          return ''+
            '<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">'+
              '<div><b>'+title+'</b><div class="tiny">'+sub+'</div></div>'+
              '<div id="'+actId+'" style="display:flex;gap:8px;align-items:center">'+
                (badge||'')+
                '<button class="btn secondary" data-act="view" data-eid="'+eid+'">View</button>'+
              '</div>'+
            '</div>';
        }).join('');

        box.querySelectorAll('button[data-act="view"]').forEach(function(b){
          b.addEventListener('click', function(){
            var id=(b.getAttribute('data-eid')||'').trim(); if(id) openEvent(String(id));
          });
        });
      })();

      // Guest events
      (function renderGuestRows(){
        var box = $('#home_guests');
        if (!guestList.length){ box.innerHTML = '<div class="muted">No upcoming events</div>'; return; }
        box.innerHTML = '';

        guestList.forEach(function(ev){
          var eid = (ev.id || ev.event_id || ev.eventId || ev.ID || ev.Id || '');
          google.script.run.withSuccessHandler(function(res){
            var live = (res && res.live) || [];
            var mine = live.filter(function(r){ return r.is_guest && String(r.owner_its)===String(state.user.its); });
            if (!mine.length) return;

            mine.forEach(function(r){
              var title = (ev.sport ? (ev.sport+' - ') : '') + (ev.name||'Event') + ' — ' + (r.name || 'Guest');
              var sub   = (ev.start_datetime ? (fmtDT(ev.start_datetime)) : '') + (ev.address ? ('<br/>' + addrHtml(ev.address)) : '');
              var badge = computeStatusBadge(r.status);
              var rowHtml =
                '<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">'+
                  '<div><b>'+title+'</b><div class="tiny">'+sub+'</div></div>'+
                  '<div style="display:flex;gap:8px;align-items:center">'+
                    (badge||'')+
                    '<button class="btn secondary" data-act="view" data-eid="'+eid+'">View</button>'+
                  '</div>'+
                '</div>';
              var t=document.createElement('template'); t.innerHTML=rowHtml.trim();
              var rowNode = t.content.firstChild;
              box.appendChild(rowNode);
              rowNode.querySelector('button[data-act="view"]').addEventListener('click', function(){ var id=(eid||'').trim(); if(id) openEvent(String(id)); });
            });
          }).api_eventDetails(eid);
        });
      })();

      // Countdown
      var cd  = $('#home_cd'); var sub = $('#home_cd_sub'); var chk = $('#home_checkin');
      function pickSelfEventForCountdown(nowVal){
        var current = selfList.find(function(e){ var s=parseDT(e.start_datetime); return s && (nowVal >= s && nowVal < new Date(s.getTime()+30*60*1000)); });
        if (current) return current;
        return selfList.find(function(e){ var s=parseDT(e.start_datetime); return s && s > nowVal; }) || null;
      }
      var next = nextSelf || pickSelfEventForCountdown(now());

      function wireTopCheckinFor(evt){
        if (!chk || !evt) return;
        chk.style.display='none'; chk.textContent='Check In Now'; chk.classList.remove('checked-in');
        chk.setAttribute('data-start', evt.start_datetime||''); chk.setAttribute('data-end', evt.end_datetime||'');
        google.script.run.withSuccessHandler(function(res){
          var mine = (res && res.live || []).find(function(r){ return !r.is_guest && String(r.person)===String(state.user.its); });
          var already = !!(mine && mine.checked_in_at);
          var can = withinCheckInWindow(evt) && !already;
          if (already){ chk.style.display='inline-flex'; chk.disabled=true; chk.classList.add('checked-in'); chk.textContent='Checked In'; }
          else if (can){ chk.style.display='inline-flex'; chk.disabled=false; chk.textContent='Check In Now'; }
          else { chk.style.display='none'; chk.disabled=true; }
        }).api_eventDetails(evt.id || evt.event_id);
        chk.onclick = function(){ var id=(evt.id||evt.event_id||'').trim(); if (id && !chk.disabled) doCheckIn(id, state.user.its, chk); };
      }

      if (!next){
        cd.textContent='You have no upcoming registrations.'; sub.textContent=''; chk.style.display='none';
      } else {
        wireTopCheckinFor(next);
        function tick(){
          var nowVal=now(); var tgt=parseDT(next.start_datetime); var diff=tgt - nowVal;
          if (diff <= 0){
            var since = nowVal - tgt;
            if (since <= 30*60*1000){
              cd.textContent='Your event has begun';
              sub.innerHTML = fmtDT(next.start_datetime) + (next.address ? ('<br/>' + addrHtml(next.address)) : '');
              refreshCheckinButtonsVisibility();
              return;
            } else {
              next = pickSelfEventForCountdown(nowVal);
              if (!next){
                cd.textContent='You have no upcoming registrations.'; sub.textContent=''; chk.style.display='none';
                clearInterval(homeTimers.cd); homeTimers.cd=null; return;
              }
              wireTopCheckinFor(next);
            }
          } else {
            cd.textContent = humanCountdown(diff) + ' until ' + ((next.sport? (next.sport+' - '):'') + (next.name||''));
            sub.innerHTML  = fmtDT(next.start_datetime) + (next.address ? ('<br/>' + addrHtml(next.address)) : '');
            refreshCheckinButtonsVisibility();
          }
        }
        tick(); homeTimers.cd = setInterval(tick, 1000);
      }
      homeTimers.uiRefresh = setInterval(refreshCheckinButtonsVisibility, 10000);
    }).api_homeListsForUser(state.user.its);

    // Upcoming across all sports
    google.script.run.withSuccessHandler(function(u){
      var list = (u && u.events) || []; var box = $('#home_upcoming');
      if (!list.length){ box.innerHTML = '<div class="muted">No upcoming events</div>'; return; }
      box.innerHTML = list.map(function(e){
        var title = (e.sport ? (e.sport+' - ') : '') + (e.name||'Event');
        var sub   = (e.start_datetime ? (fmtDT(e.start_datetime)) : '') + (e.address ? ('<br/>' + addrHtml(e.address)) : '');
        var eid   = (e.id || e.event_id || e.eventId || e.ID || e.Id || '');
        return '<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">'+
                 '<div><b>'+title+'</b><div class="tiny">'+sub+'</div></div>'+
                 '<div><button class="btn secondary" data-eid="'+eid+'">View</button></div>'+
               '</div>';
      }).join('');
      box.querySelectorAll('button[data-eid]').forEach(function(b){
        b.onclick = function(){ var id=(b.getAttribute('data-eid')||'').trim(); if(id) openEvent(String(id)); };
      });
    }).api_upcomingEvents(5);
  }

  /* ===================== PROFILE / BALANCE / CAL & GUESTS — unchanged (omitted for brevity) ===================== */
  /* (Your previous sections for pageProfile, pageBalance, pageCalendar, pageGuests can remain exactly the same.
      I left them in earlier versions; if you need them pasted again, say the word.) */

  /* ===================== SPORT PAGE ===================== */
  function pageSport(){ if(!guard())return;
    if (sportCountdownTimer) { clearInterval(sportCountdownTimer); sportCountdownTimer = null; }
    var node=el(
      '<div class="stack">'+
        '<div class="card stack">'+
          '<div class="label">Next '+state.sport+' Event</div>'+
          '<div id="sp_next" class="countdown muted">Looking for upcoming events…</div>'+
          '<div id="sp_next_sub" class="tiny"></div>'+
        '</div>'+
        '<div class="card stack">'+
          '<div class="label">Upcoming '+state.sport+' Events</div>'+
          '<div id="sp_list" class="stack"></div>'+
        '</div>'+
      '</div>'
    );
    layout(node);

    google.script.run.withSuccessHandler(function(res){
      var all = (res && res.events) || [];
      var nowTs = now();

      var list = all
        .filter(function(e){ var de = parseDT(e.end_datetime); return de && de > nowTs; })
        .sort(function(a,b){ return new Date(a.start_datetime||0) - new Date(b.start_datetime||0); });

      var nextNode = $('#sp_next'); var nextSub  = $('#sp_next_sub');
      function pickEvent(nowVal){
        var current = list.find(function(e){ var s=parseDT(e.start_datetime); return s && (nowVal >= s && nowVal < new Date(s.getTime()+30*60*1000)); });
        if (current) return current;
        return list.find(function(e){ var s=parseDT(e.start_datetime); return s && s > nowVal; }) || null;
      }
      var upcoming = pickEvent(now());
      function renderSubline(e){ nextSub.innerHTML = fmtDT(e.start_datetime) + '<br/>' + addrHtml(e.address||''); }
      function update(){
        var nowVal = now();
        if (!upcoming){ upcoming = pickEvent(nowVal); if (!upcoming){ nextNode.textContent = 'No upcoming events'; nextSub.textContent=''; return; } }
        var start = parseDT(upcoming.start_datetime); var diff  = start - nowVal;
        if (diff <= 0){
          var since = nowVal - start;
          if (since <= 30*60*1000){ nextNode.textContent = state.sport+' event has begun'; renderSubline(upcoming); return; }
          else { upcoming = pickEvent(nowVal); if (!upcoming){ nextNode.textContent='No upcoming events'; nextSub.textContent=''; return; } }
        }
        nextNode.textContent = humanCountdown(diff) + ' until ' + ((upcoming.sport? (upcoming.sport+' - '):'') + (upcoming.name||'')); renderSubline(upcoming);
      }
      if (!upcoming){ nextNode.textContent = 'No upcoming events'; nextSub.textContent=''; }
      else { update(); sportCountdownTimer = setInterval(update, 1000); }

      google.script.run.withSuccessHandler(function(st){
        var statusMap = (st && (st.self_statuses || st.statuses || st.map)) || {};
        renderSportEventList(list, statusMap);
      }).api_myStatusesForSport(state.user.its, state.sport);
    }).api_listEvents(state.sport);
  }

  function renderSportEventList(list, statusMap){
    var box = $('#sp_list'); var nowTs=now();
    list = (list||[]).filter(function(e){ var de=parseDT(e.end_datetime); return de && de > nowTs; });
    if (!list.length){ box.innerHTML = '<div class="muted">No upcoming events</div>'; return; }
    box.innerHTML = '';
    list.forEach(function(e){
      // FIX: always resolve a robust event id
      var eid = (e.id || e.event_id || e.eventId || e.ID || e.Id || '');
      var st = String(statusMap[eid]||'none').toLowerCase();

      var regStart = parseDT(e.reg_start); var regEnd = parseDT(e.reg_end); var afterClose = (regEnd && now() > regEnd);
      var regOpen = (!regStart || now() >= regStart) && (!regEnd || now() <= regEnd);

      var badgeHtml = computeStatusBadge(st);
      var capText = (e.max_capacity && Number(e.max_capacity)>0) ? String(e.max_capacity) : '—';

      var card = el(
        '<div class="event-card stack">'+
          '<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">'+
            '<div style="font-size:var(--fs-md);font-weight:800">'+(e.sport ? (e.sport+' - ') : '')+(e.name||'Untitled')+'</div>'+
            '<div>'+badgeHtml+'</div>'+
          '</div>'+
          '<div class="tiny">'+(e.address?addrHtml(e.address):'')+'</div>'+
          '<div class="tiny">Event: '+fmtDT(e.start_datetime)+' – '+fmtDT(e.end_datetime)+'</div>'+
          '<div class="tiny">Registration: '+(e.reg_start?fmtDT(e.reg_start):'—')+' → '+(e.reg_end?fmtDT(e.reg_end):'—')+'</div>'+
          '<div class="tiny">Approx Fee: '+money(e.approx_fee||0)+' | Capacity: '+capText+'</div>'+
          '<div class="event-actions">'+
            '<button class="btn" data-act="register" '+((!regOpen || st==='active' || st==='waitlist')?'disabled':'')+'>Register Me</button>'+
            '<button class="btn secondary" data-act="deregister" '+(((regOpen && (st==='active' || st==='waitlist')) || (!regOpen && st==='waitlist'))?'':'disabled')+'>Deregister</button>'+
            '<button class="btn secondary" data-act="dropout" '+((afterClose && st==='active')?'':'disabled')+'>Dropout</button>'+
            '<button class="btn secondary" data-act="view">View</button>'+
          '</div>'+
          '<div class="tiny" data-role="hint"></div>'+
          '</div>'
      );
      box.appendChild(card);

      function q(act){ return card.querySelector('[data-act="'+act+'"]'); }
      function setHint(msg){ var n=card.querySelector('[data-role="hint"]'); n.textContent=msg||''; }

      function updateCapacityLabels(){
        google.script.run.withSuccessHandler(function(res){
          var live = (res && res.live) || [];
          var activeCount = live.filter(function(r){ return String(r.status||'').toLowerCase()==='active'; }).length;
          var cap = Number(e.max_capacity||0);
          var reached = (cap>0 && activeCount>=cap);
          q('register').textContent = reached ? 'Register Me on Waitlist' : 'Register Me';
          setHint(reached ? 'Capacity is full. You will be added to the waitlist.' : '');
        }).api_eventDetails(eid);
      }
      updateCapacityLabels();

      q('register').onclick  = function(){ actRegister(eid,false); };
      q('deregister').onclick= function(){ actDeregister(eid); };
      q('dropout').onclick   = function(){ actDropout(eid); };
      q('view').onclick      = function(){ openEvent(String(eid)); };
    });
  }

  /* ===================== EVENT DETAIL (with Admin Remove) ===================== */
  function openEvent(id){
    if(!guard())return;
    var eid = String(id||'').trim();
    if (!eid || eid==='undefined' || eid==='null') { alert('Sorry, we could not resolve this event id.'); return; }

    google.script.run.withSuccessHandler(function(res){
      var evt=res.event; var live=res.live||[];

      google.script.run.withSuccessHandler(function(st){
        var map = (st && (st.map || st.statuses || st.billing_statuses)) || {};
        var myStatus = String(map[evt.id] || map[evt.event_id] || 'none').toLowerCase();

        var nowTs = now();
        var regStart = parseDT(evt.reg_start);
        var regEnd   = parseDT(evt.reg_end);
        var regOpen    = (!regStart || nowTs >= regStart) && (!regEnd || nowTs <= regEnd);
        var afterClose = (regEnd && nowTs > regEnd);

        var myBadge = computeStatusBadge(myStatus);
        var capText = (evt.max_capacity && Number(evt.max_capacity)>0) ? String(evt.max_capacity) : '—';

        var addrSafe = evt.address ? ('<a href="https://www.google.com/maps?q='+encodeURIComponent(evt.address)+'" target="_blank" rel="noopener">'+evt.address+'</a>') : '';

        var node=el(
          "<div class='stack'>"+
            "<div class='card stack'>"+
              "<div style='display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap'>"+
                "<div style='font-size:var(--fs-lg);font-weight:800'>"+(evt.sport? (evt.sport+' - '):'')+evt.name+"</div>"+
                "<div>"+myBadge+"</div>"+
              "</div>"+
              "<div class='tiny'>"+addrSafe+"</div>"+
              "<div class='tiny'>"+fmtDT(evt.start_datetime)+" – "+fmtDT(evt.end_datetime)+"</div>"+
              "<div class='tiny'>Registration: "+(evt.reg_start?fmtDT(evt.reg_start):'—')+" → "+(evt.reg_end?fmtDT(evt.reg_end):'—')+"</div>"+
              "<div class='tiny'>Approx Fee: "+money(evt.approx_fee||0)+" | Capacity: "+capText+"</div>"+
            "</div>"+

            "<div class='card stack'>"+
              "<div class='label'>Your Registration</div>"+
              "<div class='event-actions'>"+
                "<button class='btn' id='reg_me'>Register Me</button>"+
                "<button class='btn secondary' id='dereg_me'>Deregister</button>"+
                "<button class='btn secondary' id='dropout_me'>Dropout</button>"+
              "</div>"+
            "</div>"+

            "<div class='card stack'>"+
              "<div class='label'>Manage your guests for this event</div>"+
              "<select id='gx_sel' class='input'><option value=''>Select a guest…</option></select>"+
              "<div style='display:flex;gap:8px;flex-wrap:wrap'>"+
                "<button class='btn' id='reg_guest'>Register Guest</button>"+
              "</div>"+
              "<div class='tiny' id='gx_hint'></div>"+
              "<div id='my_guest_list' class='stack' style='margin-top:6px'></div>"+
            "</div>"+

            "<div class='card stack'>"+
              "<div class='label'>Live Roster List</div>"+
              "<div id='live_list'></div>"+
              "<div class='tiny' id='cap_hint'></div>"+
            "</div>"+
          "</div>"
        );
        layout(node);

        (function renderLive(){
          var canAdminRemove = (state.admin && Array.isArray(state.admin.adminSports) && state.admin.adminSports.indexOf(evt.sport) >= 0);
          var html = live.map(function(r){
            var st = String(r.status||'').toLowerCase();
            var statusBadge = (st==='active')? "<span class='badge ok'>Active</span>" :
                              (st==='waitlist')? "<span class='badge warn'>Waitlist</span>" :
                              (st==='dropout')? "<span class='badge warn'>Dropped Out</span>" : "";
            var removeBtn = canAdminRemove ? (" <button class='btn danger' data-act='admin-remove' data-person='"+r.person+"'>Remove</button>") : "";
            return "<div style='padding:6px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap'>"+
                     "<div>"+r.name+" "+statusBadge+"</div>"+
                     "<div>"+removeBtn+"</div>"+
                   "</div>";
          }).join('');
          $('#live_list').innerHTML = html || "<div class='muted'>No registrations yet</div>";

          if (canAdminRemove){
            $('#live_list').addEventListener('click', function(ev){
              var btn = ev.target.closest('button[data-act=\"admin-remove\"]'); if(!btn) return;
              var personIts = btn.getAttribute('data-person');
              if(!confirm('Remove this person from the event? This may auto-promote someone from waitlist.')) return;
              AdminAPI.removeRegistration(state.user.its, (evt.id||evt.event_id), personIts, function(r){
                if(!r || !r.ok){ alert((r && r.error) || 'Failed to remove'); return; }
                openEvent(evt.id||evt.event_id);
              }, function(e){ alert('Failed: '+(e && (e.message||e))); });
            }, { once:true });
          }
        })();

        google.script.run.withSuccessHandler(function(g){
          var sel = $('#gx_sel'); var hint= $('#gx_hint');
          var guests = (g && g.guests) || [];
          guests.forEach(function(gu){
            var opt = document.createElement('option');
            opt.value = gu.guest_its;
            opt.textContent = gu.first_name+' '+gu.last_name+' — ITS '+gu.guest_its;
            sel.appendChild(opt);
          });
          if(!guests.length){ hint.textContent = 'No saved guests yet. Add guests on the Guests tab.'; }
          if(!regOpen || !guests.length){ sel.disabled = true; $('#reg_guest').disabled = true; }

          var mine = live.filter(function(r){ return r.is_guest && String(r.owner_its)===String(state.user.its); });
          var gl = $('#my_guest_list');
          if (!mine.length){ gl.innerHTML = "<div class='muted tiny'>No guests of yours are on this event yet.</div>"; }
          else {
            gl.innerHTML = mine.map(function(r){
              var st = String(r.status||'').toLowerCase();
              var statusBadge = (st==='active') ? " <span class='badge ok'>Active</span>" :
                                (st==='waitlist') ? " <span class='badge warn'>Waitlist</span>" :
                                (st==='dropout') ? " <span class='badge warn'>Dropped Out</span>" : "";
              var canDereg = ((regOpen && (st==='active' || st==='waitlist')) || (!regOpen && st==='waitlist'));
              var canDrop  = (afterClose && st==='active');
              return ""+
              "<div class='event-card' style='padding:8px;margin-top:6px'>"+
                "<div style='display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap'>"+
                  "<div><b>"+r.name+"</b> "+statusBadge+"</div>"+
                  "<div class='event-actions'>"+
                    "<button class='btn secondary' data-gi='"+r.person+"' data-act='g-dereg' "+(canDereg?'':'disabled')+">Deregister</button>"+
                    "<button class='btn secondary' data-gi='"+r.person+"' data-act='g-drop' "+(canDrop?'':'disabled')+">Dropout</button>"+
                  "</div>"+
                "</div>"+
              "</div>";
            }).join('');
            gl.querySelectorAll('[data-act="g-dereg"]').forEach(function(b){
              b.addEventListener('click', function(){ var guestIts=b.getAttribute('data-gi');
                google.script.run.withSuccessHandler(function(r){ if(!r || !r.ok) alert((r && r.error) || 'Failed to deregister guest'); openEvent(eid); })
                  .api_deregister(state.user.its, eid, guestIts);
            });});
            gl.querySelectorAll('[data-act="g-drop"]').forEach(function(b){
              b.addEventListener('click', function(){ var guestIts=b.getAttribute('data-gi');
                google.script.run.withSuccessHandler(function(r){ if(!r || !r.ok) alert((r && r.error) || 'Failed to drop out guest'); openEvent(eid); })
                  .api_dropout(state.user.its, eid, guestIts);
            });});
          }
        }).api_listGuests(state.user.its);

        (function applySelfButtons(){
          var canRegister = regOpen && (myStatus==='none' || myStatus==='dropout');
          var canDeregister = ((regOpen && (myStatus==='active' || myStatus==='waitlist')) || (!regOpen && myStatus==='waitlist'));
          var canDropout = afterClose && myStatus==='active';
          $('#reg_me').disabled = !canRegister;
          $('#dereg_me').disabled = !canDeregister;
          $('#dropout_me').disabled = !canDropout;
        })();

        (function updateCapacityLabelsDetail(){
          var cap = Number(evt.max_capacity||0);
          google.script.run.withSuccessHandler(function(r){
            var live2 = (r && r.live) || [];
            var activeCount = live2.filter(function(x){ return String(x.status||'').toLowerCase()==='active'; }).length;
            var reached = (cap>0 && activeCount>=cap);
            $('#reg_me').textContent = reached ? 'Register Me on Waitlist' : 'Register Me';
            var rg = $('#reg_guest'); if (rg) rg.textContent = reached ? 'Register Guest on Waitlist' : 'Register Guest';
            $('#cap_hint').textContent = reached ? 'Capacity is full. New registrations will go to the waitlist.' : '';
          }).api_eventDetails(eid);
        })();

        $('#reg_me').onclick     = function(){ apiSafeRegister(evt, false); };
        $('#dereg_me').onclick   = function(){ actDeregister(eid); };
        $('#dropout_me').onclick = function(){ actDropout(eid); };

        $('#reg_guest').onclick  = function(){
          var v=($('#gx_sel').value||'').trim();
          if(!/^\d{8}$/.test(v)){ alert('Please select a guest.'); return; }
          google.script.run.withSuccessHandler(function(resp){
            if(!resp||!resp.ok){ alert((resp&&resp.error)||'Failed'); return; }
            openEvent(eid);
          }).api_register(state.user.its, eid, v, true);
        };
      }).api_myStatusesForEvents(state.user.its, [eid]);
    }).api_eventDetails(eid);
  }

  // Helper to register self where event object may have id or event_id
  function apiSafeRegister(evt, isGuest){
    var id = String(evt && (evt.id || evt.event_id) || '').trim();
    if (!id){ alert('Could not resolve event id.'); return; }
    actRegister(id, !!isGuest);
  }

  /* ===================== CREATE/EDIT PROFILE + BAL/RECPTS ADMIN — unchanged sections omitted for brevity ===================== */
  /* (If you need me to paste those again, I will. They’re identical to your latest file except for the fixes above.) */

  /* ===================== REGISTRATION ACTIONS ===================== */
  function actRegister(eventId,isGuest){
    var target;
    if (isGuest){
      var sel = $('#gx_sel');
      if (sel){ target = (sel.value||'').trim(); }
      else { var gx = $('#gx'); target = gx ? (gx.value||'').trim() : ''; }
      if(!/^\d{8}$/.test(target)) { alert('Please select a guest.'); return; }
      google.script.run.withSuccessHandler(function(res){ if(!res || !res.ok){ alert((res && res.error) || 'Failed'); return; } if (state.page==='sport') pageSport(); else openEvent(eventId); }).api_register(state.user.its,eventId,target,true);
      return;
    } else { target = state.user.its; }
    google.script.run.withSuccessHandler(function(res){ if(!res || !res.ok){ alert((res && res.error) || 'Failed'); return; } if (state.page==='sport') pageSport(); else openEvent(eventId); }).api_register(state.user.its,eventId,target,false);
  }
  function actDeregister(eventId){
    var target = state.user.its;
    google.script.run.withSuccessHandler(function(res){ if(!res || !res.ok){ alert((res && res.error) || 'Failed'); return; } if (state.page==='sport') pageSport(); else openEvent(eventId); }).api_deregister(state.user.its,eventId,target);
  }
  function actDropout(eventId){
    var target = state.user.its;
    google.script.run.withSuccessHandler(function(res){ if(!res || !res.ok){ alert((res && res.error) || 'Failed'); return; } if (state.page==='sport') pageSport(); else openEvent(eventId); }).api_dropout(state.user.its, eventId, target);
  }

  /* ===================== ADMIN: EVENTS / RECEIPTS — unchanged from your current copy ===================== */
  function pageAdminEvents(){ if(!guard())return;
    const node = el(`
      <div class="card stack">
        <div class="label">Create or Edit Event</div>
        <div class="form-grid">
          <div class="stack"><label class="label">Prefill from event</label><select id="ae_copy" class="input"></select></div>
          <div class="stack"><label class="label">Sport</label><select id="ae_sport" class="input"></select></div>
          <div class="stack"><label class="label">Event Name</label><input id="ae_name" class="input" placeholder="Name"></div>
          <div class="stack"><label class="label">Address (pick or type)</label><input id="ae_addr" class="input" list="addr_list" placeholder="Address"><datalist id="addr_list"></datalist></div>
          <div class="stack"><label class="label">Start</label><input id="ae_start" class="input" type="datetime-local"></div>
          <div class="stack"><label class="label">End</label><input id="ae_end" class="input" type="datetime-local"></div>
          <div class="stack"><label class="label">Registration Opens</label><input id="ae_reg_start" class="input" type="datetime-local"></div>
          <div class="stack"><label class="label">Registration Closes</label><input id="ae_reg_end" class="input" type="datetime-local"></div>
          <div class="stack"><label class="label">Approximate Fee</label><input id="ae_fee" class="input" type="number" step="0.01" min="0"></div>
          <div class="stack"><label class="label">Maximum Capacity</label><input id="ae_capacity" class="input" type="number" step="1" min="1" placeholder="e.g., 24"><div class="tiny">Capacity controls waitlist automatically.</div></div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
          <button class="btn" id="ae_save_new">Save as New</button>
          <button class="btn secondary" id="ae_update" disabled>Update Event</button>
          <button class="btn danger" id="ae_delete" disabled>Delete Event</button>
        </div>
        <div class="tiny" id="ae_err" style="color:var(--err)"></div>
      </div>
    `);
    layout(node);

    const hasAdminSports = (state.admin && state.admin.adminSports && state.admin.adminSports.length) ? true : false;
    if (!hasAdminSports && state.user && state.user.its){
      AdminAPI.bootstrap(state.user.its, b=>{ state.admin=Object.assign(state.admin,b||{}); render(); }, console.warn);
      return;
    }

    const toLocalDTInput = (s)=> {
      if(!s) return '';
      var d=new Date(s); if(isNaN(d)) return '';
      var yyyy=d.getFullYear(); var mm=('0'+(d.getMonth()+1)).slice(-2); var dd=('0'+d.getDate()).slice(-2);
      var hh=('0'+d.getHours()).slice(-2); var mi=('0'+d.getMinutes()).slice(-2);
      return yyyy+'-'+mm+'-'+dd+'T'+hh+':'+mi;
    };

    const sportSel = $('#ae_sport');
    (state.admin.adminSports||[]).forEach(sp=>{ const o=document.createElement('option'); o.value=sp; o.textContent=sp; sportSel.appendChild(o); });

    const dl=$('#addr_list');
    (state.admin.pastAddresses||[]).forEach(a=>{ const o=document.createElement('option'); o.value=a; dl.appendChild(o); });

    const cp=$('#ae_copy');
    const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='Choose'; cp.appendChild(placeholder);
    (state.admin.adminEvents||[]).forEach(e=>{
      const o=document.createElement('option');
      o.value=e.id; o.textContent = (e.sport || '')+' - '+e.name+' - '+fmtDT(e.start_datetime);
      cp.appendChild(o);
    });

    const startInput     = $('#ae_start');
    const endInput       = $('#ae_end');
    const regStartInput  = $('#ae_reg_start');
    const regEndInput    = $('#ae_reg_end');
    const feeInput       = $('#ae_fee');
    const capInput       = $('#ae_capacity');
    const nameInput      = $('#ae_name');
    const addrInput      = $('#ae_addr');

    let prefillBase = null; const MS_DAY = 24*60*60*1000;
    const override = { end:false, reg_start:false, reg_end:false };
    endInput.addEventListener('input', ()=> override.end = true);
    regStartInput.addEventListener('input', ()=> override.reg_start = true);
    regEndInput.addEventListener('input', ()=> override.reg_end = true);

    function enableEditButtons(enabled){ $('#ae_update').disabled = !enabled; $('#ae_delete').disabled = !enabled; }

    cp.onchange = ()=>{
      const id = cp.value; state.tmp = state.tmp || {}; state.tmp.editId = id || null; enableEditButtons(!!id);
      if(!id) return;
      const e = (state.admin.adminEvents||[]).find(ev => String(ev.id)===String(id)); if (!e) return;
      sportSel.value = e.sport || sportSel.value; nameInput.value = e.name || ''; addrInput.value = e.address || '';
      startInput.value    = toLocalDTInput(e.start_datetime);
      endInput.value      = toLocalDTInput(e.end_datetime);
      regStartInput.value = toLocalDTInput(e.reg_start);
      regEndInput.value   = toLocalDTInput(e.reg_end);
      feeInput.value = (Number(e.approx_fee||0)).toFixed(2);
      capInput.value = e.max_capacity ? String(e.max_capacity) : '';
      prefillBase = { start:parseDT(e.start_datetime), end:parseDT(e.end_datetime), reg_start:parseDT(e.reg_start), reg_end:parseDT(e.reg_end) };
      override.end = override.reg_start = override.reg_end = false;
    };

    startInput.addEventListener('input', ()=>{
      if (!prefillBase || !prefillBase.start) return;
      const newStart = new Date(startInput.value); if (isNaN(newStart)) return;
      const deltaDays = Math.round((newStart - prefillBase.start)/MS_DAY); if (!Number.isFinite(deltaDays)) return;
      if (prefillBase.end && !override.end){ endInput.value = toLocalDTInput(new Date(prefillBase.end.getTime() + deltaDays*MS_DAY)); }
      if (prefillBase.reg_start && !override.reg_start){ regStartInput.value = toLocalDTInput(new Date(prefillBase.reg_start.getTime() + deltaDays*MS_DAY)); }
      if (prefillBase.reg_end && !override.reg_end){ regEndInput.value = toLocalDTInput(new Date(prefillBase.reg_end.getTime() + deltaDays*MS_DAY)); }
    });

    function getPayload(withId){
      const payload = {
        sport: sportSel.value,
        name: (nameInput.value||'').trim(),
        address: (addrInput.value||'').trim(),
        start_datetime: startInput.value,
        end_datetime: endInput.value,
        reg_start: regStartInput.value,
        reg_end: regEndInput.value,
        approx_fee: Number(feeInput.value||0),
        max_capacity: Number(capInput.value||0)
      };
      if (withId && state.tmp && state.tmp.editId) payload.id = state.tmp.editId;
      return payload;
    }
    function requireEventFields(p){
      const errEl = $('#ae_err'); errEl.textContent='';
      const required = ['sport','name','address','start_datetime','end_datetime','reg_start','reg_end'];
      for (let i=0;i<required.length;i++){ const k=required[i]; if(!p[k]){ errEl.textContent='Please fill '+k.replace(/_/g,' '); return false; } }
      if (!(p.approx_fee>=0)){ errEl.textContent='Approximate fee must be 0 or more'; return false; }
      if (!(p.max_capacity && p.max_capacity>0 && Math.floor(p.max_capacity)===p.max_capacity)){ errEl.textContent='Maximum capacity must be a positive whole number'; return false; }
      return true;
    }
    function refreshAdmin(){
      AdminAPI.bootstrap(state.user.its, b=>{
        state.admin = Object.assign(state.admin, b||{});
        setPage('admin_events');
      }, e=> showErr('#ae_err', e));
    }

    $('#ae_save_new').onclick = ()=>{
      const payload = getPayload(false); if(!requireEventFields(payload)) return; delete payload.id;
      AdminAPI.eventSave(state.user.its, payload, ()=>{ alert('Event created.'); state.tmp = state.tmp || {}; state.tmp.editId = null; prefillBase=null; cp.value=''; enableEditButtons(false); refreshAdmin(); }, e=> showErr('#ae_err', e));
    };
    $('#ae_update').onclick = ()=>{
      if(!(state.tmp && state.tmp.editId)){ showErr('#ae_err','Choose an event to update.'); return; }
      const payload = getPayload(true); if(!requireEventFields(payload)) return;
      AdminAPI.eventSave(state.user.its, payload, ()=>{ alert('Event updated.'); refreshAdmin(); }, e=> showErr('#ae_err', e));
    };
    $('#ae_delete').onclick = ()=>{
      if(!(state.tmp && state.tmp.editId)){ showErr('#ae_err','Choose an event to delete.'); return; }
      if(!confirm('Delete this event? This will also remove it from Google Calendar.')) return;
      AdminAPI.eventDelete(state.user.its, state.tmp.editId, ()=>{ alert('Event deleted.'); state.tmp.editId = null; prefillBase=null; cp.value=''; enableEditButtons(false); refreshAdmin(); }, e=> showErr('#ae_err', e));
    };
  }

  function pageAdminReceipts(){ if(!guard())return;
    var node = el(
      '<div class="card stack">'+
        '<div class="label">Upload Receipt</div>'+
        '<div class="form-grid">'+
          '<div class="stack"><label class="label">Event</label><select id="ar_event" class="input"></select></div>'+
          '<div class="stack"><label class="label">Amount</label><input id="ar_amount" class="input" type="number" step="0.01" min="0"></div>'+
          '<div class="stack"><label class="label">Category</label>'+
            '<select id="ar_cat" class="input">'+
              '<option value="Space Rental">Space Rental</option>'+
              '<option value="Food">Food</option>'+
              '<option value="Equiptment Rental">Equiptment Rental</option>'+
              '<option value="Shirts">Shirts</option>'+
              '<option value="Referees">Referees</option>'+
              '<option value="Trophies">Trophies</option>'+
              '<option value="Printing">Printing</option>'+
              '<option value="Labor">Labor</option>'+
              '<option value="Photography">Photography</option>'+
              '<option value="Karamat">Karamat</option>'+
              '<option value="Other">Other</option>'+
            '</select>'+
          '</div>'+
          '<div class="stack"><label class="label">Receipt Date</label><input id="ar_date" class="input" type="date"></div>'+
          '<div class="stack"><label class="label">Extra Notes (optional)</label><input id="ar_notes" class="input" placeholder="Notes"></div>'+
          '<div class="stack"><label class="label">Upload Receipt</label><input id="ar_file" class="input" type="file" accept="image/*,application/pdf" required><div class="tiny">A receipt image/PDF is required.</div></div>'+
        '</div>'+
        '<div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px">'+
          '<button class="btn" id="ar_save">Save Receipt</button>'+
          '<button class="btn secondary" id="ar_finalize">Finalize Now</button>'+
        '</div>'+
        '<div class="tiny" id="ar_err" style="color:var(--err)"></div>'+
      '</div>'
    );
    layout(node);

    var hasAdminSports = (state.admin && state.admin.adminSports && state.admin.adminSports.length) ? true : false;
    if (!hasAdminSports && state.user && state.user.its){
      AdminAPI.bootstrap(state.user.its, function(b){ state.admin=Object.assign(state.admin,b||{}); pageAdminReceipts(); }, console.warn);
      return;
    }

    AdminAPI.receiptsList(state.user.its, function(res){
      var sel = $('#ar_event');
      var first=document.createElement('option'); first.value=''; first.textContent='Choose'; sel.appendChild(first);
      (res.events||[]).forEach(function(e){ var o=document.createElement('option'); o.value=e.id; o.textContent=e.label; sel.appendChild(o); });
    }, function(e){ showErr('#ar_err', e); });

    $('#ar_save').onclick = function(){
      var sel = $('#ar_event'); var errEl = $('#ar_err'); errEl.textContent='';
      var amt = Number($('#ar_amount').value||NaN);
      var cat = $('#ar_cat').value;
      var date = $('#ar_date').value;
      var fileElt = $('#ar_file'); var f = fileElt.files[0];
      if(!sel.value){ errEl.textContent='Please choose an event.'; return; }
      if(!(amt>=0)){ errEl.textContent='Please enter a valid amount (≥ 0).'; return; }
      if(!cat){ errEl.textContent='Please choose a category.'; return; }
      if(!date){ errEl.textContent='Please choose a receipt date.'; return; }
      if(!f){ errEl.textContent='Please attach a receipt image/PDF.'; return; }
      var reader = new FileReader();
      reader.onload = function(){
        var payload = { event_id: sel.value, amount: amt, category: cat, receipt_date: date, notes: $('#ar_notes').value, imageDataUrl: reader.result };
        AdminAPI.receiptSave(state.user.its, payload, function(){ alert('Receipt saved.'); $('#ar_amount').value=''; $('#ar_notes').value=''; fileElt.value=''; }, function(e){ showErr('#ar_err', e); });
      };
      reader.onerror = function(err){ showErr('#ar_err', err); };
      reader.readAsDataURL(f);
    };

    $('#ar_finalize').onclick = function(){
      var sel = $('#ar_event'); var errEl = $('#ar_err'); errEl.textContent='';
      if(!sel.value){ errEl.textContent='Please choose an event to finalize.'; return; }
      var btn = $('#ar_finalize');
      btn.disabled = true;
      AdminAPI.receiptsFinalizeNow(state.user.its, sel.value, function(r){
        btn.disabled = false;
        if(!r || !r.ok){ errEl.textContent = (r && (r.message || r.error)) || 'Failed to finalize.'; return; }
        alert('Finalized: $'+Number(r.amount||0).toFixed(2)+' per person ('+(r.posted||0)+' billable).');
      }, function(e){ btn.disabled = false; showErr('#ar_err', e); });
    };
  }
</script>
</body>
</html>
